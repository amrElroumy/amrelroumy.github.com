
<!DOCTYPE html>
<html lang="en">
    <head>
        
        <title>Singleton Pattern | Amr Elroumy's Blog</title>
        <meta name="description" content="">
        <meta name="author" content="">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
                <!-- <link href="http://fonts.googleapis.com/css?family=Aldrich|Lato:400,400italic" rel="stylesheet" type="text/css"> -->
        <!-- <link href='http://fonts.googleapis.com/css?family=Alfa+Slab+One|PT+Sans' rel='stylesheet' type='text/css'> -->
        
                <link rel="stylesheet" href="/media/css/font-awesome.css">
        <link rel="stylesheet" href="/media/css/bootstrap-responsive.min.css">
        <link rel="stylesheet" href="/media/css/style.css">
        
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

                    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src= "/media/js/jquery.timeago.min.js"></script>    
    <script type="text/javascript">
        jQuery(document).ready(function() {
            jQuery("time.timeago").timeago();
        });
    </script>

            <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'amrelroumysblog'; // required: replace example with your forum shortname
            
                        
            var disqus_identifier = '3c1a41ed-9637-49af-8b68-6283daa835f4'; // Unique identifier for each blog post to identify the comment thread
                                                                                                       //   Instead of depending on unreliable post url which could be changed
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            
                <link rel="shortcut icon" href="/favicon.ico" />
            
            </head>

    <body>

        
        <!-- Blog Continer -->
        <div class="container-fluid">

            <!-- Blog Top Bar -->
                            <div id="topbar">
    <h2 id="topbar-title">
      <a href="/index.html">
          <div class="logo" ></div>
          Amr Elroumy's Blog
      </a>
  </h2>
</div>                        <!-- End Blog Top Bar -->

            <div class="row-fluid">
                <!-- Sidebar Menu -->
                                     <div class="span3" id="sidebar">
    <ul class="sidebar-menu sidebar-nav-fixed">
        <li>
            <div class="sidebar-menu-item-wrapper">
                <a href="/">
                    <i class="icon-home icon-white"></i>
                    <span>Home</span>
                </a>
            </div>
        </li>
        <li>
            <div class="sidebar-menu-item-wrapper">
                <a href="/blog/">
                    <i class="icon-list-alt icon-white"></i>
                    <span>Blog</span>
                </a>
            </div>
        </li>
        <li>
            <div class="sidebar-menu-item-wrapper">
                <a href="/about/">
                    <i class="icon-info-sign icon-white"></i>
                    <span>About Me</span>
                </a>
            </div>
        </li>
    </ul>
</div>                                <!-- End Sidebar Menu -->

                <div class="span9">
                    <div class="content"> 
                            <div class="row-fluid page-header">
        <div class="span9">
            <h1>
                Singleton Pattern
            </h1>
        </div>
        <div class="span3 date"><time class="timeago"
      datetime="2011-08-01T02:08:56Z"
      pubdate>
  <abbr class="published updated" title="2011-08-01T02:08:56Z">August 01, 2011</abbr>
</time>
</div>
    </div>
    <h2>Pattern&nbsp;Name</h2>
<p>Singleton&nbsp;Pattern</p>
<h2>Classification</h2>
<p>Creational&nbsp;Pattern</p>
<h2>Intent</h2>
<blockquote>
<p>Ensure a class only has one instance, and offer a global point of access to that&nbsp;instance.</p>
</blockquote>
<h2>Motivation</h2>
<p>In many situations you’d find yourself in need of ensuring that a certain class can only be instantiated once and is accessible in various parts of a system.    <br>
Example for such situations&nbsp;is:</p>
<ul>
<li>Database&nbsp;access</li>
<li>Logging</li>
<li>Communication</li>
<li>Printer&nbsp;spooling</li>
<li>File&nbsp;systems</li>
</ul>
<p>The singleton pattern provides us with two&nbsp;properties:</p>
<ul>
<li>It ensures a class is only instantiated&nbsp;once. </li>
<li>It provides a global access point to that&nbsp;class. </li>
</ul>
<p><strong>Note </strong>
Singletons are meant to be used sparingly, so if you find yourself using them everywhere you might want to take another look at your&nbsp;design.</p>
<h2>Applicability</h2>
<p>Use The <strong>Singleton pattern</strong> when you want your classes to provide you with only one instance that is globally accessible to the code from an access&nbsp;point.</p>
<h2>Structure</h2>
<p><img alt="Singleton" src="http://amrelroumy.files.wordpress.com/2011/08/singleton28.png"></p>
<h2>Participants</h2>
<p><strong>SingletonClass:</strong> This class provide global access to only a single instance of it by doing the following:<br>
</p>
<ul>
<li>It hides its constructor to prevent any external classes from creating new&nbsp;instances. </li>
<li>It declares the static method <em>GetInstance()</em> that provides access to the single instance that is held in the private variable: <strong>instance</strong>. </li>
</ul>
<h2>Consequences</h2>
<p>Like any pattern, the singleton pattern has its tradeoffs (according to its implementation) and if it is used while being unaware of these tradeoffs can produce unwanted&nbsp;results.</p>
<h3>Criticisms</h3>
<p><strong>First criticism:</strong> Using it is considered a breach to one of the <span class="caps">OOD</span> Principles: The <strong>Single Responsibility Principle</strong>, which states&nbsp;that: </p>
<blockquote>
<p>Every object should have a single responsibility, and that this responsibility should be entirely encapsulated by the&nbsp;class.</p>
</blockquote>
<p>Thus, the class shouldn’t care less for being a <strong>Singleton </strong>or not, as it’s only concern should be doing its business responsibility. But when using <strong>Singleton</strong>, the class is responsible for two things&nbsp;here:</p>
<ul>
<li>Its original business&nbsp;responsibility.</li>
<li>Managing the instantiation of its&nbsp;objects.</li>
</ul>
<hr>
<p><strong>Second criticism:</strong> We all know that having global variables in our code, produces code smells. But, isn’t this what the <strong>Singleton Pattern </strong>does? It makes an instance of the class accessible globally. There disadvantages of using global variables that apply when we use Singletons without proper care because of the similarity in their&nbsp;nature. </p>
<p>Some of these disadvantages&nbsp;are:</p>
<ul>
<li><strong>Implicit <a href="http://en.wikipedia.org/wiki/Coupling_(computer_programming)">coupling</a> - </strong>Many programmers unconsciously would tightly couple the class that uses the <strong>Singleton Pattern </strong>with the rest of their code, because it’s globally accessible. When this is done, the overuse of this pattern could converge into becoming an&nbsp;anti-pattern.</li>
<li><strong>Namespace pollution - </strong>Namespace pollution<strong> </strong>can occur when we abuse <strong>Singleton Pattern</strong>, though it is a bit unlikely if the pattern is used&nbsp;wisely.</li>
<li>Multithreading issues can occur when more than one thread the <em>GetInstance()</em> method is invoked for the first time. This will result in instantiating many instance at the same time. That’s why it is important to make sure that our code is thread safe by using <strong>Synchronization</strong> (sometimes discouraged because of its performance footprint), <strong><a href="http://en.wikipedia.org/wiki/Lazy_instantiation">Lazy Instantiation</a></strong> using <strong>double-checked locking</strong>, or <strong>Early Instantiation</strong>.<strong> </strong>Choosing the implementation to use depends mainly on your needs and the available&nbsp;resources.</li>
<li>Unit-testing programs that contain singleton objects can become annoying because the <strong>Singleton</strong> objects have a persistent state throughout the program. Leading to the&nbsp;following: </li>
<li>It makes it hard to replicate the tests for later testing or even having a clean environment for&nbsp;testing. </li>
<li>It takes away one thing that makes unit testing effective which is having tests that are independent on each&nbsp;other.</li>
<li>Also many developers prefer making dependencies between classes obvious through method signatures, rather than having the <strong>Singleton</strong> object hidden in the code, lurking for the right moment to come and bite you in the back. Some might argue that passing that object through all this methods induces tight coupling, but on the contrary this way of exchanging objects allows you to write to an interface that can be easily extended without having to change a single line in your old code. <strong>Thus you’re coupling to an interface not to an&nbsp;implementation.</strong></li>
</ul>
<hr>
<p>If we want to overcome the mentioned shortcomings, we could separate the singleton part from the actual object, allowing for the object itself to be used normally if needed. Perhaps we can use a Factory or a builder that would encapsulate the object creation and maintain having only one instance created of this class, while leaving the class responsible only for its business&nbsp;responsibility. </p>
<p><span class="caps">J. B.</span> Rainsberger argued in his article “<a href="http://www.ibm.com/developerworks/webservices/library/co-single/index.html#h3">Use your Singletons wisely</a>” that classes should not be responsible for the singleton part of the&nbsp;code:</p>
<blockquote>
<p>Suppose an application needs only one instance of a class and the application configures that class at startup: Why should the class itself be responsible for being a singleton? It seems quite logical for the application to take on this responsibility, since the application requires this kind of behavior. The application, not the component, should be the singleton. The application then makes an instance of the component available for any application-specific code to use. When an application uses several such components, it can aggregate them into what we have called a&nbsp;toolbox.</p>
</blockquote>
<h2>Implementation</h2>
<h3>Naïve&nbsp;implementation</h3>
<p><div class="codebox"><figure class="code"><div class="highlight"><pre><span class="k">public</span> <span class="k">class</span> <span class="nc">Singleton</span><br /><span class="p">{</span><br />    <span class="k">private</span> <span class="k">static</span> <span class="n">Singleton</span> <span class="n">_instance</span><span class="p">;</span><br />&nbsp;<br />    <span class="k">private</span> <span class="nf">Singleton</span><span class="p">()</span><br />    <span class="p">{</span> <span class="p">}</span><br />&nbsp;<br />    <span class="k">public</span> <span class="n">Singleton</span> <span class="nf">GetInstance</span><span class="p">()</span><br />    <span class="p">{</span><br />        <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span><br />            <span class="n">_instance</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="p">();</span><br />        <span class="k">return</span> <span class="n">_instance</span><span class="p">;</span><br />    <span class="p">}</span><br /><span class="p">}</span><br /></pre></div><br /><figcaption>C#</figcaption></figure></div></p>
<h4><strong>Disadvantages of this&nbsp;implementation:</strong></h4>
<p>It is not thread safe as in some situations, separate threads can invoke the GetInstance for the first time simultaneously. So when both of them reaches the statement <code>if (_instance == null)</code> it will be evaluated as true, thus both threads will see that it is valid to instantiate a new object. To avoid this issue, we have to write thread-safe code&nbsp;.</p>
<h3>Thread-safe Singleton using <strong>a simple Lazy&nbsp;Instantiation</strong></h3>
<p><div class="codebox"><figure class="code"><div class="highlight"><pre><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">Singleton</span><br /><span class="p">{</span><br />    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">Singleton</span> <span class="n">instance</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="p">();</span><br />&nbsp;<br />    <span class="k">private</span> <span class="nf">Singleton</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span><br />&nbsp;<br />    <span class="k">public</span> <span class="k">static</span> <span class="n">Singleton</span> <span class="n">Instance</span><br />    <span class="p">{</span><br />        <span class="k">get</span><br />        <span class="p">{</span><br />            <span class="k">return</span> <span class="n">instance</span><span class="p">;</span><br />        <span class="p">}</span><br />    <span class="p">}</span><br /><span class="p">}</span><br /></pre></div><br /><figcaption>C#</figcaption></figure></div></p>
<p>Having the <strong>Singleton </strong>instance referenced by a private static member variable, gives us an advantage: the actual instantiation of the <strong>Singleton</strong> object doesn’t occur until the class is referenced by a call to the Instance property. Thus, this solution provides us with a form of Lazy&nbsp;Instantiation.</p>
<h3>Thread-safe Singleton using <strong>Double-Checked&nbsp;Locking</strong></h3>
<p><div class="codebox"><figure class="code"><div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span><br />&nbsp;<br /><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">Singleton</span><br /><span class="p">{</span><br />    <span class="k">private</span> <span class="k">static</span> <span class="n">volatile</span> <span class="n">Singleton</span> <span class="n">_instance</span><span class="p">;</span><br />    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">Lock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span><br />&nbsp;<br />    <span class="k">private</span> <span class="nf">Singleton</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span><br />&nbsp;<br />    <span class="k">public</span> <span class="k">static</span> <span class="n">Singleton</span> <span class="n">Instance</span><br />    <span class="p">{</span><br />        <span class="k">get</span><br />        <span class="p">{</span><br />            <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span><br />            <span class="p">{</span><br />                <span class="k">lock</span> <span class="p">(</span><span class="n">Lock</span><span class="p">)</span><br />                <span class="p">{</span><br />                    <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span><br />                        <span class="n">_instance</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="p">();</span><br />                <span class="p">}</span><br />            <span class="p">}</span><br />            <span class="k">return</span> <span class="n">_instance</span><span class="p">;</span><br />        <span class="p">}</span><br />    <span class="p">}</span><br /><span class="p">}</span><br /></pre></div><br /><figcaption>C#</figcaption></figure></div></p>
<h4>This specific implementation of Double-Checked locking can be factored&nbsp;into:</h4>
<p>When working in a multi-threaded environment, we risk running into issues that arise from resource-sharing between multiple threads, like deadlocks and race conditions (<a href="http://stackoverflow.com/questions/34510/what-is-a-race-condition">What is a race condition?</a>). This implementation of the <strong>Singleton Pattern </strong>however saves us from all this&nbsp;drama. </p>
<ul>
<li>Using <strong>volatile</strong>&nbsp;keyword.</li>
<li>Using the <strong>lock </strong>statement to accomplish thread&nbsp;synchronization.</li>
<li>Using <strong>double-checked locking</strong>.</li>
</ul>
<p>The use of the <strong>volatile</strong> keyword on the <strong>instance </strong>member variable allows us to avoid the unexpected and unpredictable results in multi-threaded programs that access fields without synchronization and using the lock statement to synchronize access. The <strong>volatile </strong>keyword indicates that a certain field can be modified by multiple threads, avoiding the compiler optimizations that assume access by a single thread. This ensures that the most up-to-date value is present in the field at all times.<br>
</p>
<p>For more details on the volatile keyword and volatile fields check the following references:
<em> <a href="http://msdn.microsoft.com/en-us/library/x13ttww7.aspx">volatile (C# Reference) [<span class="caps">MSDN</span> Library]</a>
</em> <a href="http://msdn.microsoft.com/en-us/library/aa645755(v=vs.71).aspx">Volatile fields [<span class="caps">MSDN</span>&nbsp;Library]</a></p>
<hr>
<p>Having data shared between threads is the best recipe for obscure errors and complexity when working in a multithreaded environment. A way of solving this problem is using locks in order to stop more than one thread from working on the same data at the same time.<br>
</p>
<p>The <strong>lock</strong> keyword marks a statement block as a critical section by obtaining the mutual-exclusion lock for a given object, executing a statement, and then releasing the lock (source: <a href="http://msdn.microsoft.com/en-us/library/c5kehkcz(v=VS.100).aspx">lock Statement [<span class="caps">MSDN</span> Library]</a>). The idea is to ensure that a thread can’t enter a critical area in the code, when another thread is still executing it. If two threads encounter a lock, one thread waits(blocks) until the lock becomes available.<br>
</p>
<p>So, in layman’s terms we can say that the mutual-exclusion lock acts as a simple door lock. You enter a room, you lock the door behind you and when you finish your business, you unlock the door and come out of the room, only then can somebody else enter. If anybody tries to enter the room while you are still in there, he has to&nbsp;wait.</p>
<h3>Important&nbsp;Notes</h3>
<ul>
<li>It’s a matter of good practice to avoid locking on a public type or an object that is accessible to other classes, because this risks running into performance issues and even deadlocks. Instead, we should use values of objects that are specifically made for the sole purpose of locking. These objects are commonly declared as <strong>private </strong>or <strong>private static</strong>.</li>
<li>It’s also worth knowing that when using mutual-exclusion locks, the blocked thread doesn’t consume any <span class="caps">CPU</span> resources unlike other locks like the <a href="http://en.wikipedia.org/wiki/Spinlock">Spinlock</a>, nevertheless each has its advantages and&nbsp;usages.</li>
</ul>
<hr>
<p>You might ask yourself why can’t I just simply use the lock this&nbsp;way:</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="k">get</span><br /><span class="p">{</span><br />    <span class="k">lock</span> <span class="p">(</span><span class="n">Lock</span><span class="p">)</span><br />    <span class="p">{</span><br />        <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span><br />            <span class="n">_instance</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="p">();</span><br />    <span class="p">}</span><br />    <span class="k">return</span> <span class="n">_instance</span><span class="p">;</span><br /><span class="p">}</span><br /></pre></div><br /><figcaption>C#</figcaption></figure></div>

<p>instead of the implemented&nbsp;one:</p>
<div class="codebox"><figure class="code"><div class="highlight"><pre><span class="k">get</span><br /><span class="p">{</span><br />    <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span><br />    <span class="p">{</span><br />        <span class="k">lock</span> <span class="p">(</span><span class="n">Lock</span><span class="p">)</span><br />        <span class="p">{</span><br />            <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span><br />                <span class="n">_instance</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="p">();</span><br />        <span class="p">}</span><br />    <span class="p">}</span><br />    <span class="k">return</span> <span class="n">_instance</span><span class="p">;</span><br /><span class="p">}</span><br /></pre></div><br /><figcaption>C#</figcaption></figure></div>

<p>The problem with the first implementation is that it hinders the performance of the application because of the constant locking every time an instance is requested. Unlike the <strong>double-checked locking</strong> implementation, which makes sure that a <strong>lock </strong>is actually necessary and that there is no available&nbsp;instance.</p>
<h2>Related&nbsp;Patterns</h2>
<p>Abstract Factory , Builder , and&nbsp;Prototype.</p>
<h3>References</h3>
<ul>
<li><a href="http://en.wikipedia.org/wiki/Design_Patterns">Design Patterns: Elements of Reusable Object-Oriented Software</a> – The Gang of Four (GoF): <a href="http://en.wikipedia.org/wiki/Erich_Gamma">Erich Gamma</a>, Richard Helm, <a href="http://en.wikipedia.org/wiki/Ralph_Johnson_(computer_scientist)">Ralph Johnson</a>, <a href="http://en.wikipedia.org/wiki/John_Vlissides">John M. Vlissides</a>. </li>
<li><a href="http://oreilly.com/catalog/9780596007126">Head First Design Patterns</a> – <a href="http://www.oreillynet.com/pub/au/2003">Eric T Freeman</a>, <a href="http://www.oreillynet.com/pub/au/2002">Elisabeth Robson</a>, <a href="http://www.oreillynet.com/pub/au/1085">Bert Bates</a>, <a href="http://www.oreillynet.com/pub/au/1084">Kathy Sierra</a>. </li>
<li><a href="http://blogs.msdn.com/b/scottdensmore/archive/2004/05/25/140827.aspx">Why Singletons are Evil</a> - <a href="http://blogs.msdn.com/b/scottdensmore/">Scott&nbsp;Densmore</a></li>
<li><a href="http://csharpindepth.com/Articles/General/Singleton.aspx">Implementing the Singleton Pattern in C# - C# in&nbsp;Depth</a></li>
</ul>
            <div id="disqussion_thread">
            <h2>Comments</h2>
            <div id="disqus_thread"></div>
        </div>
                       </div>
                </div>
            </div>

                        <div class="row-fluid">
                <div class="span12 site-footer">
                    ©2011-2012 <a href="/about">Amr Ahmed Elroumy</a> <br />Powered by <a href="https://github.com/hyde/hyde" title="The beast under the hood" target="_blank">Hyde</a>
                </div>
            </div>
            
        </div>
        <!-- End Blog Container -->

        
                    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33968631-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>            </body>
</html>